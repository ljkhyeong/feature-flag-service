# ADR-002: SDK Config Endpoint & Rollout Policy

## 상태
Accepted (2025-09-06)

## 배경
- 클라이언트 SDK는 환경별 플래그 구성을 실시간으로 내려받아야 한다.
- 효율을 위해 ETag/304 기반 캐싱, gzip 전송 필요.
- 점진적 롤아웃과 특정 사용자 타겟팅을 지원해야 한다.

## 결정
1. 엔드포인트
    - `/sdk/v1/config?env={env}`
    - 헤더: `ETag`, `Cache-Control: no-cache`
    - If-None-Match → 304 응답
2. 직렬화 스키마
    - 필드: env, version, flags[]
    - flags: { key, enabled, rolloutPercentage?, include?, exclude? }
3. rollout 로직
    - 해시(userId) % 100 < rolloutPercentage
    - include → 무조건 true
    - exclude → 무조건 false
    - 순서: exclude > include > rollout > 기본 enabled
4. rulesJson
    - DB에는 JSON 문자열로 저장
    - `{ include:[], exclude:[] }` 구조 권장
    - 파싱 시 배열/문자열 모두 허용

## 근거
- 단순하면서도 점진적 릴리즈와 타겟팅 가능
- DB 스키마 변경 최소화 (String json 그대로 사용)
- SDK/서버 간 캐싱 효율 극대화

## 결과
- REST Docs에 SDK config 200/304 + rollout/include/exclude 문서화
- e2e 테스트 통과, 캐시/ETag 동작 확인
